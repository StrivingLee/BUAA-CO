# P7 设计文档

[TOC]

# 设计草稿

## 一、设计与测试说明

1. 处理器为 32 位五级流水线处理器

2. 支持延迟槽

3. 支持如下指令集：

   ```mipsasm
   add, sub, and, or, slt, sltu, lui
   addi, andi, ori
   lb, lh, lw, sb, sh, sw
   mult, multu, div, divu, mfhi, mflo, mthi, mtlo
   beq, bne, jal, jr
   mfc0, mtc0, eret, syscall
   ```

5. 采用全速转发的设计

6. 转发的数据来源为流水线寄存器

7. 采用模块化和层次化设计，顶层文件为 mips.v，接口定义如下：

   ```verilog
   module mips(
       input clk,                    // 时钟信号
       input reset,                  // 同步复位信号
       input interrupt,              // 外部中断信号
       output [31:0] macroscopic_pc, // 宏观 PC
   
       output [31:0] i_inst_addr,    // IM 读取地址（取指 PC）
       input  [31:0] i_inst_rdata,   // IM 读取数据
   
       output [31:0] m_data_addr,    // DM 读写地址
       input  [31:0] m_data_rdata,   // DM 读取数据
       output [31:0] m_data_wdata,   // DM 待写入数据
       output [3 :0] m_data_byteen,  // DM 字节使能信号
   
       output [31:0] m_int_addr,     // 中断发生器待写入地址
       output [3 :0] m_int_byteen,   // 中断发生器字节使能信号
   
       output [31:0] m_inst_addr,    // M 级 PC
   
       output w_grf_we,              // GRF 写使能信号
       output [4 :0] w_grf_addr,     // GRF 待写入寄存器编号
       output [31:0] w_grf_wdata,    // GRF 待写入数据
   
       output [31:0] w_inst_addr     // W 级 PC
   );
   ```





## 二、整体结构

### 1.模块规格

- IFU
  - 端口说明
  
    | 序号 |     信号名      | 方向 |                            描述                            |
    | :--: | :-------------: | :--: | :--------------------------------------------------------: |
    |  1   |       clk       |  I   |                          时钟信号                          |
    |  2   |      reset      |  I   |          同步复位信号<br>1'b1：清零<br>1'b0：保持          |
    | 3 | en | I | IM 使能信号 |
    |  4   | NPC[31:0] | I | 32 位当前指令计数，接收 NPC 的 NPC 信号 |
    |  5   |     PC[31:0]     |  O   |          输出 PC 信号           |
    
  - 功能定义
  
    | 序号 |   功能   |                   描述                    |
    | :--: | :------: | :---------------------------------------: |
    |  1   | 同步复位 | reset 信号为 1'b1 时，置 PC 为 0x00003000 |
    |  2   | 输出 PC  |             输出当前指令计数              |




- D_REG

    - 端口说明
    
      | 序号 |    信号名     | 方向 |                   描述                   |
      | :--: | :-----------: | :--: | :--------------------------------------: |
      |  1   |      clk      |  I   |                 时钟信号                 |
      |  2   |     reset     |  I   | 同步复位信号<br>1b'1：清零<br>1'b0：保持 |
      |  3   |      en       |  I   |                 使能信号                 |
      |  4   |  F_PC[31:0]   |  I   |               F 级指令计数               |
      |  5   | F_Instr[31:0] |  I   |                 F 级指令                 |
      |  6   |  D_PC[31:0]   |  O   |               D 级指令计数               |
      |  7   | D_Instr[31:0] |  O   |                 D 级指令                 |

    - 功能定义
    
      | 序号 |       功能       | 描述 |
      | :--: | :--------------: | :--: |
      |  1   | 传递 PC 和 Instr |  -   |



- NPC

  - 端口说明

    | 序号 |     信号名     | 方向 |                         描述                          |
    | :--: | :------------: | :--: | :---------------------------------------------------: |
    |  1   |      Zero      |  I   |                 ALU 运算结果是否为 0                  |
    |  2   |  GreaterZero   |  I   | SrcA 是否 > 0的标志信号，接收 ALU 的 GreaterZero 信号 |
    |  3   |      beq       |  I   |                  当前指令是否为 beq                   |
    |  4   |      bne       |  I   |                  当前指令是否为 bne                   |
    |  4   |      bgtz      |  I   |                  当前指令是否为 bgtz                  |
    |  5   |      jal       |  I   |                  当前指令是否为 jal                   |
    |  6   |       jr       |  I   |                   当前指令是否为 jr                   |
    |  7   |   F_PC[31:0]   |  I   |                    接收 F_PC 信号                     |
    |  8   |   D_PC[31:0]   |  I   |                    接收 D_PC 信号                     |
    |  8   |  Imm26[25:0]   |  I   |              接收 Splitter 的 Imm26 信号              |
    |  9   | EXTImm32[31:0] |  I   |               接收 EXT 的 EXTImm32 信号               |
    |  10  | GRF[rs]\[31:0] |  I   |                   接收 GRF[rs] 的值                   |
    |  11  |   NPC[31:0]    |  O   |                Next PC，下一条指令计数                |
  
  - 功能定义
  
    | 序号 |   功能   |          描述           |
    | :--: | :------: | :---------------------: |
    |  1   | 计算 NPC | 根据NPCControl 计算 NPC |



- CMP

  - 端口说明

    | 序号 |   信号名   | 方向 |     描述     |
    | :--: | :--------: | :--: | :----------: |
    |  1   | SrcA[31:0] |  I   | 第一个计算数 |
    |  2   | SrcB[31:0] |  I   | 第二个计算数 |
    |  3   |    Zero    |  I   |     相等     |
    |  4   |     GZ     |  O   |    A > B     |
    |  5   |     LZ     |  O   |    A < B     |

  - 功能定义

    | 序号 | 功能 |          描述          |
    | :--: | :--: | :--------------------: |
    |  1   | 比较 | 比较 SrcA 与 SrcB 大小 |



- GRF

  - 端口说明

    | 序号 | 信号名 | 方向 | 描述 |
    | :----: | :------: | :----: | :----: |
    | 1    | clk    | I    | 时钟信号 |
    | 2 | reset | I | 同步复位信号<br>1b'1：清零<br>1'b0：保持 |
    | 3 | RegWrite | I | 写使能信号，接受 RegWrite <br>1'b1：可写入数据<br>1'b0：不可写入数据 |
    | 4 | A1[4:0] | I | 5 位地址位选信号，接收 rs |
    | 5 | A2[4:0] | I | 5 位地址位选信号，接收 rt |
    | 6 | RegAddr[4:0] | I | 5 位地址位选信号，选择写入的寄存器 |
    | 7 | RegData[31:0] | I | 32 位写入数据 |
    | 8 | PC[31:0] | I | 当前指令计数 |
    | 9 | RD1[31:0] | O | 输出 GRF[rs] |
    | 10 | RD2[31:0] | O | 输出 GRF[rt] |
    
  - 功能定义

    | 序号 | 功能 | 描述 |
    | :----: | :----: | :----: |
    | 1 | 同步复位 | reset 信号为 1'b1 时，将所有寄存器清空为 32'b0 |
    | 2 | 读寄存器 | 将 A1 和 A2 对应的寄存器中的值输出到 RD1 和 RD2 |
    | 3 | 写寄存器 | RegWrite 置高且 RegAddr 不为 5'b0 时，在时钟上升沿将 RegData 的值写入到 RegAddr 对应的寄存器中 |
    

.


- EXT

  - 端口说明

    | 序号 |     信号名      | 方向 |                             描述                             |
    | :--: | :-------------: | :--: | :----------------------------------------------------------: |
    |  1   |   Imm16[15:0]   |  I   |                    16 位需要扩展的立即数                     |
    |  2   | EXTControl[1:0] |  I   | 符号扩展的标志信号<br>接收 Controller 产生的 EXTControl 信号<br>2'b00：零扩展<br>2'b01：符号扩展<br>2'b10：低位零扩展 |
    |  3   | EXTResult[31:0] |  O   |                        32 位扩展结果                         |

  - 功能定义

    | 序号 |     功能     | 描述 |
    | :--: | :----------: | :--: |
    |  1   | 高位符号扩展 |  -   |
    |  2   |  高位零扩展  |  -   |
    |  3   |  低位零扩展  |  -   |

.


- E_REG

    - 端口说明
    
      | 序号 |      信号名       | 方向 |                   描述                   |
      | :--: | :---------------: | :--: | :--------------------------------------: |
      |  1   |        clk        |  I   |                 时钟信号                 |
      |  2   |       reset       |  I   | 同步复位信号<br>1b'1：清零<br>1'b0：保持 |
      |  3   |        clr        |  I   |                 清空信号                 |
      |  4   |    D_PC[31:0]     |  I   |               D 级指令计数               |
      |  5   |   D_Instr[31:0]   |  I   |                 D 级指令                 |
      |  6   |    D_WD1[31:0]    |  I   |               D 级 GPR[rs]               |
      |  7   |    D_WD2[31:0]    |  I   |               D 级 GPR[rt]               |
      |  8   | D_EXTResult[31:0] |  I   |              D 级 EXT 结果               |
      |  9   |    E_PC[31:0]     |  O   |               E 级指令计数               |
      |  10  |   E_Instr[31:0]   |  O   |                 E 级指令                 |
      |  11  |    E_WD1[31:0]    |  O   |               E 级 GPR[rs]               |
      |  12  |    E_WD1[31:0]    |  O   |               E 级 GPR[rs]               |
      |  13  | E_EXTResult[31:0] |  O   |              E 级 EXT 结果               |

    - 功能定义
    
      | 序号 |                功能                 | 描述 |
      | :--: | :---------------------------------: | :--: |
      |  1   | 传递 Instr、PC、WD1、WD2、EXTResult |  -   |




- ALU

  - 端口说明

    | 序号 | 信号名 | 方向 | 描述 |
    | :----: | :------: | :----: | :----: |
    | 1 | SrcA[31:0] | I | 第一个运算数 |
    | 2 | SrcB[31:0] | I | 第二个运算数 |
    | 3 | ALUControl[2:0] | I | ALU 控制信号，对应的操作为：<br>3'b000：+<br>3'b001：-<br>3‘b010：\^（按位异或）<br>3'b011：\|（按位）<br>3'b100：<<（左移） |
    | 4 | shamt[4:0] | I | - |
    | 5 | ALUResult[31:0] | O | SrcA 与 SrcB 运算结果 |
    
  - 功能定义
    | 序号 |      功能      |                    描述                     |
    | :--: | :------------: | :-----------------------------------------: |
    |  1   |      加法      |        输出 SrcA + SrcB 到 ALUResult        |
    |  2   |      减法      |        输出 SrcA - SrcB 到 ALUResult        |
    |  3   |     按位与     |        输出 SrcA & SrcB 到 ALUResult        |
    |  4   |     按位或     |       输出 SrcA \| SrcB 到 ALUResult        |
    |  5   |    按位异或    |        输出SrcA ^ SrcB 到 ALUResult         |
    |  6   |      左移      |       输出 SrcA << shamt 到 ALUResult       |
    |  7   | 有符号小于置 1 | 当 SrcA < SrcB（有符号），置 ALUResult 为 1 |
    |  8   | 无符号小于置 1 | 当 SrcA < SrcB（无符号），置 ALUResult 为 1 |
    




- MDU

  - 端口说明

    | 序号 |     信号名      | 方向 |                    描述                    |
    | :--: | :-------------: | :--: | :----------------------------------------: |
    |  1   |       clk       |  I   |                  时钟信号                  |
    |  2   |      reset      |  I   | 同步复位信号<br/>1b'1：清零<br/>1'b0：保持 |
    |  3   | MDUControl[3:0] |  I   |               MDU 的控制信号               |
    |  4   |   SrcA[31:0]    |  I   |                第一个运算数                |
    |  5   |   SrcB[31:0]    |  I   |                第二个运算数                |
    |  6   |      Start      |  I   |                                            |
    |  7   |      Busy       |  O   |                  是否“忙”                  |
    |  8   |    HI[31:0]     |  O   |                                            |
    |  9   |    LO[31:0]     |  O   |                                            |
  
  - 功能定义
  
    | 序号 |    功能    | 描述 |
    | :--: | :--------: | :--: |
    |  1   | 乘除法运算 |      |
    |      |            |      |
    |      |            |  -   |




- M_REG

    - 端口说明
    
      | 序号 |      信号名       | 方向 |                   描述                   |
      | :--: | :---------------: | :--: | :--------------------------------------: |
      |  1   |        clk        |  I   |                 时钟信号                 |
      |  2   |       reset       |  I   | 同步复位信号<br>1b'1：清零<br>1'b0：保持 |
      |  3   |        clr        |  I   |                 清空信号                 |
      |  4   |    E_PC[31:0]     |  I   |               E 级指令计数               |
      |  5   |   E_Instr[31:0]   |  I   |                 E 级指令                 |
      |  6   |    E_WD2[31:0]    |  I   |               E 级 GPR[rt]               |
      |  7   | E_ALUResult[31:0] |  I   |              E 级 ALU 结果               |
      |  8   | E_EXTResult[31:0] |  I   |              E 级 EXT 结果               |
      |      |    E_HI[31:0]     |  I   |                 E 级 HI                  |
      |      |    E_LO[31:0]     |  I   |                 E 级 LO                  |
      |  9   |    M_PC[31:0]     |  O   |               M 级指令计数               |
      |  10  |   M_Instr[31:0]   |  O   |                 M 级指令                 |
      |  11  |    M_WD2[31:0]    |  O   |               M 级 GPR[rt]               |
      |  12  | M_ALUResult[31:0] |  O   |              M 级 ALU 结果               |
      |  13  | M_EXTResult[31:0] |  O   |              M 级 EXT 结果               |
      |      |    M_HI[31:0]     |  O   |                 M 级 HI                  |
      |      |    M_LO[31:0]     |  O   |                 M 级 LO                  |
    - 功能定义
    
      | 序号 |                       功能                        | 描述 |
      | :--: | :-----------------------------------------------: | :--: |
      |  1   | 传递 Instr、PC、WD2、ALUResult、EXTResult、HI、LO |  -   |




- W_REG

    - 端口说明
    
      | 序号 |      信号名       | 方向 |                   描述                   |
      | :--: | :---------------: | :--: | :--------------------------------------: |
      |  1   |        clk        |  I   |                 时钟信号                 |
      |  2   |       reset       |  I   | 同步复位信号<br>1b'1：清零<br>1'b0：保持 |
      |  3   |    M_PC[31:0]     |  I   |               M 级指令计数                 |
      |  4   |   M_Instr[31:0]   |  I   |                 M 级指令                 |
      |  5  | M_ALUResult[31:0] |  I   |              M 级 ALU 结果              |
      |  6  | M_EXTResult[31:0] |  I   |              M 级 EXT 结果              |
      | 7 | M_HI[31:0] | I | M 级 HI |
      | 8 | M_LO[31:0] | I | M 级 LO |
      | 9 | M_MemReadData[31:0] | I | M 级 DM 结果 |
      |  10  |    W_PC[31:0]    |  O   |               W 级指令计数               |
      |  11  |   W_Instr[31:0]   |  O   |                 W 级指令                 |
      |  12  | W_ALUResult[31:0] |  O   |              W 级 ALU 结果               |
      |  13  | W_EXTResult[31:0] |  O   |              W 级 EXT 结果               |
      | 14 | W_HI[31:0] | O | W 级 HI |
      | 15 | W_LO[31:0] | O | W 级 LO |
      | 16 | W_MemReadData[31:0] | O | W 级 DM 结果 |
      
    - 功能定义
    
      | 序号 |                             功能                             | 描述 |
      | :--: | :----------------------------------------------------------: | :--: |
      |  1   | 传递 Instr、PC、WD2、ALUResult、EXTResult、MemReadData、HI、LO |  -   |




- Controller

  - 端口说明
    | 序号 |     信号名      | 方向 |                             描述                             |
    | :--: | :-------------: | :--: | :----------------------------------------------------------: |
    |  1   |   Instr[31:0]   |  I   |                       32 位 MIPS 指令                        |
    |  2   |     rs[4:0]     |  O   |                              -                               |
    |  3   |     rt[4:0]     |  O   |                              -                               |
    |  4   |     rd[4:0]     |  O   |                              -                               |
    |  5   |   shamt[4:0]    |  O   |                              -                               |
    |  6   |   Imm16[15:0]   |  O   |                              -                               |
    |  7   |   Imm26[25:0]   |  O   |                              -                               |
    |  8   | ALUControl[2:0] |  O   |      ALU 控制信号，确定 ALU 执行的功能，端口说明见 ALU       |
    |  9   |    MemWrite     |  O   |                          DM 写信号                           |
    |  10  |    RegWrite     |  O   |                          GRF 写信号                          |
    |  11  |  Mem2Reg[2:0]   |  O   | GRF 写入数据的选择信号<br>3'b0：ALU 运算结果<br>3'b1：Memory[Addr]<br>3'b10：EXT 运算结果<br>3'b11：PC + 4 |
    |  12  | EXTControl[1:0] |  O   | EXT 扩展方式选择信号<br>2'b00：零扩展<br>2'b01：符号扩展<br>2'b10：低 16 位零扩展 |
    |  13  |     ALUSrc      |  O   | ALU 的第二个操作数选择信号<br>1'b0：RD2<br>1'b1：EXT 扩展的立即数 |
    |  14  |  RegAddr[4:0]   |  O   |                         寄存器写地址                         |
    |  11  | MDUControl[3:0] |  O   | 乘除法选择信号<br>4'b0000：递增<br>3'b001：beq 指令跳转<br>3'b010：j 指令跳转<br>3'b011：GRF[rs] |
    |  12  |  SControl[3:0]  |  O   |                     store 类指令位宽选择                     |
    |  13  |  LControl[3:0]  |  O   |                     load 类指令位宽选择                      |
    |  14  |     calc_r      |  O   |                                                              |
    |  15  |     calc_i      |  O   |                                                              |
    |  16  |       beq       |  O   |                      当前指令是否为 beq                      |
    |  17  |      bgtz       |  O   |                     当前指令是否为 bgtz                      |
    |  18  |       jal       |  O   |                      当前指令是否为 jal                      |
    |  19  |       jr        |  O   |                      当前指令是否为 jr                       |
    |  20  |      load       |  O   |                  当前指令是否为 load 类指令                  |
    |  21  |      store      |  O   |                 当前指令是否为 store 类指令                  |
    |  22  |       lui       |  O   |                      当前指令是否为 lui                      |
    |  23  |       md        |  O   |                    当前指令是否为乘除指令                    |
    |  24  |       mf        |  O   |                   当前指令是否为 mfhi/mflo                   |
    |  25  |       mt        |  O   |                   当前指令是否为 mthi/mtlo                   |
  - 功能定义
    | 序号 |       功能        | 描述 |
    | :--: | :---------------: | :--: |
    |  1   | 产生 ALU 控制信号 |  -   |
    |  2   | 产生 GRF 控制信号 |  -   |
    |  3   | 产生 DM 控制信号  |  -   |
    |  4   | 产生 EXT 控制信号 |  -   |
    |  5   | 产生 IFU 控制信号 |  -   |
    |  6   | 输出当前指令类型  |  -   |





# 思考题



1、请查阅相关资料，说明鼠标和键盘的输入信号是如何被 CPU 知晓的？

> 鼠标和键盘等外设并不是直接与CPU相连的，中间需要通过软件来连接，这个软件也就是我们熟知的驱动。驱动和硬件之间通过操作系统进行处理。最终CPU进入中断处理区的对应位置，处理输入信号。



2、请思考为什么我们的 CPU 处理中断异常必须是已经指定好的地址？如果你的 CPU 支持用户自定义入口地址，即处理中断异常的程序由用户提供，其还能提供我们所希望的功能吗？如果可以，请说明这样可能会出现什么问题？否则举例说明。（假设用户提供的中断处理程序合法）

> 因为中断异常处理程序是在程序所有程序运行前就已经写好了，设置固定的地址，就能保证异常或者中断来临的时候呢能够跳转到正确的地址进行处理。如果由用户提供中断异常处理程序的话，它跳转的地址也是计算出来的，但是如果在算跳转地址的时候出现了错误，那就无法正常进行异常处理行为。



3、为何与外设通信需要 Bridge？

> 外设的种类是无穷无尽的，而 CPU 的指令集却是有限的。我们并不能总是因为新加入了一个外设，就专门为这个外设增加新的 CPU 指令。所以需要一个系统桥去连接CPU和外设，对外只留出简洁的接口，不显示其他细节，让CPU访问外设只需通过地址就可以，这样也是体现了"高内聚，低耦合"的原则。
>    



4、请阅读官方提供的定时器源代码，阐述两种中断模式的异同，并分别针对每一种模式绘制状态移图。

> 



5、倘若中断信号流入的时候，在检测宏观 PC 的一级如果是一条空泡（你的 CPU 该级所有信息均为空）指令，此时会发生什么问题？在此例基础上请思考：在 P7 中，清空流水线产生的空泡指令应该保留原指令的哪些信息？

> 可能会出现宏观PC的错误，而且延迟槽标记信号也会出现问题。如果是中断或者异常指令造成的流水线清空，应该保持原有的PC值，以保证宏观PC的正确。如果是阻塞造成的DE级流水线清除，应该要保持原有的PC并且保持原有的BD标志信号。



6、为什么 `jalr` 指令为什么不能写成 `jalr $31, $31`？

> ```
>// D_REG.v
> wire D_RegAddr[4:0];
> wire E_check;
> ```
> 
> 指令集要求。寄存器说明符 rs 和 rd 不得相等，因为此类指令在重新执行时不具有相同的效果。执行此类指令的结果是不可预测的。此限制允许异常处理程序在分支延迟槽中发生异常时通过重新执行分支来恢复执行。
